# Stores the public key for SSH shared-key authentication, update with your SSH RSA public key
passwd:
  users:
    - name: core
      ssh_authorized_keys:
        - ssh-rsa AAAAB3NzaC1yc2EAAAABJQAAAQEA4giEY9NfIhEd16jBxAYSDAx+Drc0bV09rYaIyitUNrbpKVQ0Nm2yYn3VgKrPZnUEcNgtLTD1nB68QzfIJfWgQhv0V+z/EhnNDoAkxvFrW1MNDBzgrtHJEKvkVacI7zEAA/TLkrvyyVDjC3ETtA2Pye6l2Lnq5gDrgcJ6Q8eOM3LroH5E8jXmCSQI4xJuILl9M/glBapzJb/R85O02v9KpBOQJSrGmSKnWzxWaNvjnBvylkUZ8vd6i7yuby4RwhBgohgF9FP0MUHT/bqx8lVZUjiqNZUtsaxdH5SsEdMlMXKcLw/Q5d9VEMDFWxESKc0h8mT6INCVLFlGqJicijQylw==
        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC3ckcUy+ysoytNKdqdyVUCp3TVQlfrVZwlLWWY10t43qrCo+3+8Ccd/Or7HPERUyKQu7fW+Cd8J766ckdcZPSn6Fk6PFf87jHsVqcin5mmhF3T74oFlEg4b++ieKcNKjFH9DopvclzIA07AuZMfbNe1tumak+O2FMkelkHTsUQ7QiJ/etYPmJ+FpD9KnTiHm6eF5wmrobxuavOLIhP9JvlzM6E3uNV+B6S7geqH9wRxEDBVLUQVnZQAtiZlk8RUmJsMHfHBx4Vg3Uqs8/pCPf1tJPOqkIsxzvGHn+wB9ypsvY190aAW1CvAIHM5fL82seKfpPHo9078qDz32mZ7wQn

systemd:
  units:
    - name: fleet.service
      enable: true

    - name: etcd2.service
      enable: true
      dropins:
        - name:
          content: |
            [Service]
            Environment="ETCD_ADVERTISE_CLIENT_URLS=http://10.81.22.22:2379,http://10.81.22.22:4001"
            Environment="ETCD_DISCOVERY=https://discovery.etcd.io/f4041a6e31731f41aa2b0971b9340563"
            Environment="ETCD_INITIAL_ADVERTISE_PEER_URLS=http://10.81.22.22:2380"
            Environment="ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379,http://0.0.0.0:4001"
            Environment="ETCD_LISTEN_PEER_URLS=http://10.81.22.22:2380"
            Environment="ETCD_NAME=kube-a"

    - name: 00-ens192.network
      enable: true
      content: |
        [Match]
        Name=ens192
        [Network]
        Address=10.0.0.101/24
        
# Creates an LVM thinpool for Docker storage, will only run if the logical volume does not exist
# Change /dev/sdb to the disk you want to use for Docker storage
    - name: create-docker-lvm-thinpool.service
      enable: true
      content: |
        [Unit]
        After=lvm2-monitor.service
        Requires=lvm2-monitor.service
        ConditionPathExists=!/dev/mapper/docker-thinpool
        [Service]
        Type=oneshot
        ExecStart=/usr/sbin/pvcreate /dev/sdb
        ExecStart=/usr/sbin/vgcreate docker /dev/sdb
        ExecStart=/usr/sbin/lvcreate --wipesignatures y -n thinpool docker -l 95%VG
        ExecStart=/usr/sbin/lvcreate --wipesignatures y -n thinpoolmeta docker -l 1%VG
        ExecStart=/usr/sbin/lvconvert -y --zero n -c 512K --thinpool docker/thinpool --poolmetadata docker/thinpoolmeta
        ExecStart=/usr/sbin/lvchange --metadataprofile docker-thinpool docker/thinpool

# Updates the systemd Docker service to use Direct LVM storage and changes the container size to 25GB
# Requires the LVM thinpool from the previous unit exists
    - name: docker.service
      drop-ins:
        - name: 10.docker_opts.conf
          content: |
            [Service]
            Environment="DOCKER_OPTS=--storage-driver=devicemapper --storage-opt=dm.thinpooldev=/dev/mapper/docker-thinpool --storage-opt=dm.use_deferred_removal=true --storage-opt=dm.basesize=25G"

# Creates a new LVM volume group for custom logical volumes, will only run if the volume group does not exist
# Change /dev/sdc to the disk you want to use for the data volume group
    - name: create-data-volume-group.service
      enable: true
      content: |
        [Unit]
        Description=Create data volume group
        After=lvm2-activation.service
        Requires=lvm2-activation.service
        ConditionPathExists=/etc/check_vg.sh
        [Service]
        Type=oneshot
        ExecStart=/bin/sh /etc/check_vg.sh data /dev/sdc


files:

# Required for the volume group check
  - path: /etc/check_vg.sh
    user: root
    contents: |
      if ! $(/usr/sbin/vgs $1 >/dev/null 2>&1); then
        /usr/sbin/pvcreate $2
        /usr/sbin/vgcreate $1 $2
        /usr/sbin/vgs $1 >/dev/null 2>&1
      fi

# Required for the Docker storage LVM thinpool
  - path: /etc/lvm/profile/docker-thinpool.profile
    mode: 0644
    user: root
    contents: |
      activation {
          thin_pool_autoextend_threshold=80
          thin_pool_autoextend_percent=20
      }
      
# Required to replace 'MYIP' with IP address of server in etcd2 service environment file
  - path: /etc/replace_MYIP.sh
    user: root
    contents: |
      sed -i 's/MYIP/'$(ip -o -f inet addr show dev ens192 | awk '{print $4}' | awk -F'/' '{print $1}')'/g' /run/systemd/system/etcd2.service.d/20-cloudinit.conf
      sed -i 's/MYNAME/'$(hostnamectl --static status)'/g' /run/systemd/system/etcd2.service.d/20-cloudinit.conf

# Add bash profile preferences
  - path: /etc/profile.env
    contents: |
      alias ll='ls -l --color=auto'
      export PATH=$PATH:/opt/bin
